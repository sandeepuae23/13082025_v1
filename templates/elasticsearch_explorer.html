{% extends "base.html" %}

{% block title %}Elasticsearch Explorer - Oracle to Elasticsearch Migration{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-search me-2"></i>
            Elasticsearch Cluster Explorer
        </h1>
    </div>
</div>

<!-- Connection Management -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-server me-2"></i>
                    Elasticsearch Connections
                </h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addConnectionModal">
                    <i class="fas fa-plus me-1"></i>Add Connection
                </button>
            </div>
            <div class="card-body">
                <div id="connections-list">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Loading connections...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cluster Explorer -->
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Indices
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <select class="form-select" id="connectionSelect" onchange="loadIndices()">
                        <option value="">Select a connection...</option>
                    </select>
                </div>
                <div id="indices-list">
                    <p class="text-muted mb-0">Select a connection to view indices</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Index Details
                </h5>
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#createIndexModal">
                    <i class="fas fa-plus me-1"></i>Create Index
                </button>
            </div>
            <div class="card-body">
                <div id="index-details">
                    <p class="text-muted mb-0">Select an index to view its mapping and structure</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cluster Health -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-heartbeat me-2"></i>
                    Cluster Health & Statistics
                </h5>
            </div>
            <div class="card-body">
                <div id="cluster-health">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Loading cluster health...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Connection Modal -->
<div class="modal fade" id="addConnectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Elasticsearch Connection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="connectionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="connectionName" class="form-label">Connection Name</label>
                                <input type="text" class="form-control" id="connectionName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="environment" class="form-label">Environment</label>
                                <select class="form-select" id="environment" required>
                                    <option value="">Select environment...</option>
                                    <option value="dev">Development</option>
                                    <option value="staging">Staging</option>
                                    <option value="prod">Production</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="host" class="form-label">Host</label>
                                <input type="text" class="form-control" id="host" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="port" class="form-label">Port</label>
                                <input type="number" class="form-control" id="port" value="9200">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username (Optional)</label>
                                <input type="text" class="form-control" id="username">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">Password (Optional)</label>
                                <input type="password" class="form-control" id="password">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useSSL">
                            <label class="form-check-label" for="useSSL">
                                Use SSL/TLS
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="testConnection()">
                    <i class="fas fa-plug me-1"></i>Test Connection
                </button>
                <button type="button" class="btn btn-primary" onclick="saveConnection()">
                    <i class="fas fa-save me-1"></i>Save Connection
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Index Modal -->
<div class="modal fade" id="createIndexModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Index</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createIndexForm">
                    <div class="mb-3">
                        <label for="indexName" class="form-label">Index Name</label>
                        <input type="text" class="form-control" id="indexName" required>
                        <div class="form-text">Index names must be lowercase and can contain letters, numbers, and hyphens</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="indexMapping" class="form-label">Index Mapping (Optional)</label>
                        <textarea class="form-control" id="indexMapping" rows="10" 
                            placeholder='{"properties": {"field_name": {"type": "text"}}}'></textarea>
                        <div class="form-text">Leave empty for dynamic mapping or provide custom mapping in JSON format</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createIndex()">
                    <i class="fas fa-plus me-1"></i>Create Index
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_js %}
<script>
let currentConnectionId = null;
let currentIndexName = null;

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadConnections();
});

async function loadConnections() {
    try {
        const response = await axios.get('/api/elasticsearch/connections');
        const connections = response.data;
        
        const container = document.getElementById('connections-list');
        const select = document.getElementById('connectionSelect');
        
        // Update connections list
        if (connections.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0">No Elasticsearch connections configured</p>';
        } else {
            let html = '<div class="list-group">';
            connections.forEach(conn => {
                const envBadge = getEnvironmentBadge(conn.environment);
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${conn.name} ${envBadge}</h6>
                            <small class="text-muted">${conn.host}:${conn.port}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" 
                                onclick="testExistingConnection(${conn.id})">
                                <i class="fas fa-plug"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" 
                                onclick="selectConnection(${conn.id})">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Update connection selector
        select.innerHTML = '<option value="">Select a connection...</option>';
        connections.forEach(conn => {
            select.innerHTML += `<option value="${conn.id}">${conn.name} (${conn.environment})</option>`;
        });
        
    } catch (error) {
        console.error('Error loading connections:', error);
        document.getElementById('connections-list').innerHTML = 
            '<p class="text-danger mb-0">Error loading connections</p>';
    }
}

function getEnvironmentBadge(environment) {
    const badges = {
        'dev': 'bg-info',
        'staging': 'bg-warning',
        'prod': 'bg-danger'
    };
    
    return `<span class="badge ${badges[environment] || 'bg-secondary'}">${environment}</span>`;
}

async function saveConnection() {
    const formData = {
        name: document.getElementById('connectionName').value,
        environment: document.getElementById('environment').value,
        host: document.getElementById('host').value,
        port: parseInt(document.getElementById('port').value),
        username: document.getElementById('username').value || null,
        password: document.getElementById('password').value || null,
        use_ssl: document.getElementById('useSSL').checked
    };
    
    try {
        await axios.post('/api/elasticsearch/connections', formData);
        
        // Close modal and reload connections
        bootstrap.Modal.getInstance(document.getElementById('addConnectionModal')).hide();
        document.getElementById('connectionForm').reset();
        loadConnections();
        
        alert('Connection saved successfully!');
    } catch (error) {
        console.error('Error saving connection:', error);
        alert('Error saving connection: ' + (error.response?.data?.error || 'Unknown error'));
    }
}

async function testConnection() {
    const formData = {
        name: document.getElementById('connectionName').value,
        environment: document.getElementById('environment').value,
        host: document.getElementById('host').value,
        port: parseInt(document.getElementById('port').value),
        username: document.getElementById('username').value || null,
        password: document.getElementById('password').value || null,
        use_ssl: document.getElementById('useSSL').checked
    };
    
    try {
        // Create temporary connection for testing
        const createResponse = await axios.post('/api/elasticsearch/connections', formData);
        const connectionId = createResponse.data.id;
        
        const testResponse = await axios.post(`/api/elasticsearch/connections/${connectionId}/test`);
        
        if (testResponse.data.success) {
            alert('Connection test successful!');
        } else {
            alert('Connection test failed: ' + testResponse.data.message);
        }
    } catch (error) {
        console.error('Error testing connection:', error);
        alert('Connection test failed: ' + (error.response?.data?.error || 'Unknown error'));
    }
}

async function testExistingConnection(connectionId) {
    try {
        const response = await axios.post(`/api/elasticsearch/connections/${connectionId}/test`);
        
        if (response.data.success) {
            alert('Connection test successful!');
        } else {
            alert('Connection test failed: ' + response.data.message);
        }
    } catch (error) {
        console.error('Error testing connection:', error);
        alert('Connection test failed: ' + (error.response?.data?.error || 'Unknown error'));
    }
}

function selectConnection(connectionId) {
    document.getElementById('connectionSelect').value = connectionId;
    loadIndices();
    loadClusterHealth(connectionId);
}

async function loadIndices() {
    const connectionId = document.getElementById('connectionSelect').value;
    const container = document.getElementById('indices-list');
    
    if (!connectionId) {
        container.innerHTML = '<p class="text-muted mb-0">Select a connection to view indices</p>';
        return;
    }
    
    currentConnectionId = connectionId;
    container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Loading indices...</div>';
    
    try {
        const response = await axios.get(`/api/elasticsearch/connections/${connectionId}/indices`);
        const indices = response.data;
        
        if (indices.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0">No indices found</p>';
            return;
        }
        
        let html = '<div class="list-group list-group-flush">';
        indices.forEach(index => {
            html += `
                <a href="#" class="list-group-item list-group-item-action" 
                   onclick="loadIndexDetails('${index.index_name}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${index.index_name}</h6>
                            <small class="text-muted">${index.doc_count} docs · ${index.store_size}</small>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </a>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    } catch (error) {
        console.error('Error loading indices:', error);
        container.innerHTML = '<p class="text-danger mb-0">Error loading indices</p>';
    }
}

async function loadIndexDetails(indexName) {
    if (!currentConnectionId) return;
    
    currentIndexName = indexName;
    const container = document.getElementById('index-details');
    container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>Loading index details...</div>';
    
    try {
        const [fieldsResponse, mappingResponse] = await Promise.all([
            axios.get(`/api/elasticsearch/connections/${currentConnectionId}/indices/${indexName}/fields`),
            axios.get(`/api/elasticsearch/connections/${currentConnectionId}/indices/${indexName}/mapping`)
        ]);
        
        const fields = fieldsResponse.data;
        const mapping = mappingResponse.data;
        
        let html = `
            <div class="mb-3">
                <h6>Index: ${indexName}</h6>
            </div>
            
            <ul class="nav nav-tabs" id="indexTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="fields-tab" data-bs-toggle="tab" 
                        data-bs-target="#fields" type="button" role="tab">
                        Fields (${fields.length})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="mapping-tab" data-bs-toggle="tab" 
                        data-bs-target="#mapping" type="button" role="tab">
                        Raw Mapping
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="indexTabsContent">
                <div class="tab-pane fade show active" id="fields" role="tabpanel">
                    <div class="table-responsive mt-3">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Field Name</th>
                                    <th>Type</th>
                                    <th>Format</th>
                                    <th>Analyzer</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        fields.forEach(field => {
            html += `
                <tr>
                    <td><strong>${field.field_name}</strong></td>
                    <td><span class="badge bg-info">${field.type}</span></td>
                    <td>${field.format || '-'}</td>
                    <td>${field.analyzer || '-'}</td>
                </tr>
            `;
        });
        
        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="tab-pane fade" id="mapping" role="tabpanel">
                    <div class="mt-3">
                        <pre class="bg-dark p-3 rounded"><code>${JSON.stringify(mapping, null, 2)}</code></pre>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <button class="btn btn-primary" onclick="proceedToMapping()">
                    <i class="fas fa-arrow-right me-1"></i>Use for Mapping
                </button>
            </div>
        `;
        
        container.innerHTML = html;
    } catch (error) {
        console.error('Error loading index details:', error);
        container.innerHTML = '<p class="text-danger mb-0">Error loading index details</p>';
    }
}

async function loadClusterHealth(connectionId) {
    try {
        const response = await axios.get(`/api/elasticsearch/connections/${connectionId}/indices`);
        const indices = response.data;
        
        const totalDocs = indices.reduce((sum, index) => sum + index.doc_count, 0);
        const totalIndices = indices.length;
        
        const container = document.getElementById('cluster-health');
        let html = `
            <div class="row text-center">
                <div class="col-md-3">
                    <h4 class="text-success">${totalIndices}</h4>
                    <small class="text-muted">Total Indices</small>
                </div>
                <div class="col-md-3">
                    <h4 class="text-info">${totalDocs.toLocaleString()}</h4>
                    <small class="text-muted">Total Documents</small>
                </div>
                <div class="col-md-3">
                    <h4 class="text-warning">Active</h4>
                    <small class="text-muted">Cluster Status</small>
                </div>
                <div class="col-md-3">
                    <h4 class="text-primary">Connected</h4>
                    <small class="text-muted">Connection Status</small>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    } catch (error) {
        console.error('Error loading cluster health:', error);
        document.getElementById('cluster-health').innerHTML = 
            '<p class="text-danger mb-0">Error loading cluster health</p>';
    }
}

async function createIndex() {
    const indexName = document.getElementById('indexName').value.trim();
    const mappingText = document.getElementById('indexMapping').value.trim();
    
    if (!indexName || !currentConnectionId) {
        alert('Please enter an index name and select a connection');
        return;
    }
    
    let mapping = {};
    if (mappingText) {
        try {
            mapping = JSON.parse(mappingText);
        } catch (error) {
            alert('Invalid JSON in mapping. Please check the format.');
            return;
        }
    }
    
    try {
        await axios.post(`/api/elasticsearch/connections/${currentConnectionId}/indices`, {
            index_name: indexName,
            mapping: mapping
        });
        
        // Close modal and reload indices
        bootstrap.Modal.getInstance(document.getElementById('createIndexModal')).hide();
        document.getElementById('createIndexForm').reset();
        loadIndices();
        
        alert('Index created successfully!');
    } catch (error) {
        console.error('Error creating index:', error);
        alert('Error creating index: ' + (error.response?.data?.error || 'Unknown error'));
    }
}

function proceedToMapping() {
    if (!currentConnectionId || !currentIndexName) {
        alert('Please select a connection and index');
        return;
    }
    
    // Store connection and index info in sessionStorage for the mapping interface
    sessionStorage.setItem('elasticsearchConnectionId', currentConnectionId);
    sessionStorage.setItem('elasticsearchIndex', currentIndexName);
    
    // Navigate to mapping interface
    window.location.href = '/mapping-interface';
}
</script>
{% endblock %}
